<!DOCTYPE html>
<html lang="en">

<script>
  document.documentElement.classList.add('loading');
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Profile | BulSU MSC</title>
  <link rel="icon" href="./Logos/Bulsu MSC Logo-02.png" type="image/png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Segoe+UI:wght@400;700&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="src/output.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer="" src="js/tabs.js"></script>

  <style>
    html,
    body {
      background-color: #00071c;
      margin: 0;
      height: 100%;
    }

    html.loading body {
      display: none;
    }

    @font-face {
      font-family: "Veonika";
      src: url("https://fonts.cdnfonts.com/s/72818/veonika_free.woff") format("woff");
    }

    /* Use Segoe UI for the main title on all devices */
    h1 {
      font-family: "Segoe UI", "Segoe UI Web", "Segoe UI Symbol",
        "Helvetica Neue", "Arial", sans-serif;
    }

    /* Use Orbitron for general headings on mobile, Veonika on desktop for some */
    h2,
    h3 {
      font-family: "Orbitron", sans-serif;
    }

    main,
    body {
      background-color: #080c24;
    }

    #main-header {
      background-color: #00071c;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    #main-header.header-scrolled {
      background-color: #00071c;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4),
        0 2px 4px -1px rgba(0, 0, 0, 0.4);
    }

    .nav-link {
      color: #d1d5db;
      /* Tailwind grayâ€‘300 */
      transition: color 0.3s;
    }

    .nav-link:hover {
      color: #b9da05;
    }

    .nav-icon-wrapper {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      transition: all 0.3s;
      cursor: pointer;
    }

    .nav-icon-wrapper:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-icon {
      color: white;
      font-size: 1.25rem;
      /* text-xl */
      transition: transform 0.3s, color 0.3s;
    }

    .nav-icon-wrapper:hover .nav-icon {
      color: #b9da05;
      transform: scale(1.1);
    }

    /* Toast notification*/
    @keyframes slide-in {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-in {
      animation: slide-in 0.4s ease-out;
    }

    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
      background-color: #1e293b;
      /* bg-slate-800 */
    }

    ::-webkit-scrollbar-thumb {
      background-color: #b9da05;
      /* green-400 */
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #d1d5db;
      /* gray-300 */
    }

    /* Base input, select, and textarea styling */
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="email"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      color: #f3f4f6;
      font-size: 0.95rem;
      background-color: #0b1c3a;
      border: 1px solid #334155;
      padding: 0.5rem;
      margin-top: 0.2rem;
      border-radius: 0.375rem;
      transition: all 0.2s ease-in-out;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    /* Focus */
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #b9da05;
      box-shadow: 0 0 0 2px #b9da05;
    }

    input:disabled,
    select:disabled {
      background-color: #1e293b;
      cursor: not-allowed;
      opacity: 0.7;
    }

    input[type="file"]::file-selector-button {
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      border: 0;
      border-radius: 0.375rem;
      font-weight: 600;
      background-color: #b9da05;
      color: #000;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    input[type="file"]::file-selector-button:hover {
      background-color: #a5c604;
    }

    input[type="file"] {
      cursor: pointer;
    }

    /* Date * time picker colors */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    input[type="datetime-local"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>

<body class="">
  <nav class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 ease-in-out py-4" id="main-header">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <a class="flex items-center space-x-2 text-white transition-colors duration-300 hover:text-[#b9da05]"
        href="index.html">
        <img alt="BULSU MSC Logo" class="h-12" src="./Logos/Bulsu MSC Logo-02.png" />
      </a>
      <div class="hidden md:flex items-center space-x-8">
        <a href="dashboard.html"
          class="text-gray-400 font-semibold transition-colors duration-300 hover:text-[#b9da05] cursor-pointer">Home</a>
        <a href="announcements.html"
          class="text-gray-400 font-semibold transition-colors duration-300 hover:text-[#b9da05] cursor-pointer">Announcements</a>
        <a href="events-and-register-events.html"
          class="text-gray-400 font-semibold transition-colors duration-300 hover:text-[#b9da05] cursor-pointer">Events</a>

        <a href="edit_profile.html" class="nav-icon-wrapper">
          <i class="fa-solid fa-circle-user nav-icon"></i>
        </a>

        <a href="calendar.html" class="nav-icon-wrapper">
          <i class="fa-solid fa-calendar-days nav-icon"></i>
        </a>

        <a href="settings.html" class="nav-icon-wrapper">
          <i class="fa-solid fa-gear nav-icon"></i>
        </a>
      </div>
      <div class="md:hidden flex items-center space-x-4">
        <button class="text-gray-300 hover:text-[#b9da05] focus:outline-none" id="mobile-menu-button">
          <i class="fas fa-bars text-2xl transition-transform duration-300" id="mobile-menu-icon"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Sidebar -->
  <div id="mobile-sidebar"
    class="fixed top-[64px] left-0 w-64 h-[calc(100%-64px)] bg-[#00071c] bg-opacity-100 backdrop-blur-md z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
    <div class="p-6 space-y-4 text-white font-semibold">
      <a href="dashboard.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-circle-info text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Home</span>
      </a>

      <a href="announcements.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-bell text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Announcements</span>
      </a>

      <a href="events-and-register-events.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-calendar-alt text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Events</span>
      </a>

      <a href="edit_profile.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-user-circle text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Edit Profile</span>
      </a>

      <a href="calendar.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-calendar-days text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Calendar</span>
      </a>

      <a href="settings.html"
        class="flex items-center space-x-4 p-2 rounded-md group hover:bg-white/10 transition-colors duration-300 cursor-pointer">
        <i
          class="fa-solid fa-gear text-xl w-6 text-center group-hover:text-[#b9da05] group-hover:scale-110 transition-all duration-300">
        </i>
        <span>Settings</span>
      </a>
    </div>
  </div>

  <main class="pt-28 flex justify-center">
    <section id="header"
      class="w-[96%] mx-auto mb-8 bg-transparent flex flex-col lg:flex-row gap-5 items-stretch rounded min-h-[calc(100vh-7rem)]">

      <!-- Left Section: Profile -->
      <div class="w-full lg:w-2/6 rounded-lg bg-[#011538] border border-[#b9da05] self-stretch">
        <div class="px-4 sm:px-6 py-4">
          <div class="mb-4 text-right w-full">
            <h4 class="text-white py-2 px-2 text-sm font-semibold uppercase tracking-wider" id="msc_id">
            </h4>
          </div>

          <div>
            <div class="w-28 h-28 mx-auto mb-4 rounded-full shadow-md overflow-hidden" id="profile-picture-container">
              <!-- Default: Profile pic thru user's initials -->
            </div>
          </div>

          <div class="flex flex-col items-center justify-center text-center">
            <h2 class="text-3xl text-white font-bold mb-1" id="fullName"></h2>
            <p class="text-sm text-white mb-6" id="studentID"></p>
          </div>

          <div class="w-full h-px bg-white my-4"></div>

          <div class="text-center mb-6 w-full">
            <h3 class="text-white text-lg font-bold" id="program"></h3>
            <p class="text-white" id="college"></p>
            <p class="text-white" id="year_level"></p>
          </div>

          <div class="flex flex-col items-center justify-center text-center">
            <div class="mb-4 w-32 h-32 bg-white p-1 rounded-lg flex items-center justify-center">
              <!-- Dyamic QR Code -->
              <div id="qr-code" class="w-full h-full"></div>
            </div>

            <!-- <p class="text-sm text-blue-200 mb-6">ID No. </p> -->

            <div class="flex gap-2 mt-4">
              <span class="bg-[#03850a] text-white px-4 py-1 rounded-full text-xs">
                Active
              </span>
              <span class="bg-[#03378f] text-white px-4 py-1 rounded-full text-xs" id="role">
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Section -->
      <section id="rightSection" class="w-full h-full lg:w-4/5 flex flex-col self-stretch rounded-lg">
        <!-- Personal Info -->
        <section id="editContainer" class="w-full h-full rounded-lg border border-[#b9da05]">
          <div class="bg-[#011538] pt-4 px-4 sm:px-6 pb-6 rounded-lg relative">
            <h2 class="mb-4 text-lg sm:text-xl font-bold text-white">Personal Information</h2>
            <div class="absolute top-4 right-4">
              <button id="saveBtn"
                class="px-2 text-gray-400 hover:text-[#b9da05] transition-colors pointer-events-none opacity-50"
                onclick="updateProfile()" title="Save changes">
                <i class="fas fa-save w-4 h-4 text-xl"></i>
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
              <div class="md:col-span-2">
                <p class="text-lg text-[#b9da05] font-semibold mb-2">Personal Details</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <label for="firstName" class="text-white text-sm mb-1 font-semibold">First Name</label>
                    <input type="text" id="firstName" name="firstName" placeholder="Enter first name" />
                  </div>
                  <div>
                    <label for="middleName" class="text-white text-sm mb-1 font-semibold">Middle Name</label>
                    <input type="text" id="middleName" name="middleName" placeholder="Enter middle name" />
                  </div>
                  <div>
                    <label for="lastName" class="text-white text-sm mb-1 font-semibold">Last Name</label>
                    <input type="text" id="lastName" name="lastName" placeholder="Enter last name" />
                  </div>
                  <div>
                    <label for="name_suffix" class="text-white text-sm mb-1 font-semibold">Name Suffix</label>
                    <select id="name_suffix" name="name_suffix"
                      class="w-full p-2 mt-1 rounded border border-gray-700 text-white">
                      <option value="">None</option>
                      <option value="Jr.">Jr.</option>
                      <option value="Sr.">Sr.</option>
                      <option value="I">I</option>
                      <option value="II">II</option>
                      <option value="III">III</option>
                      <option value="IV">IV</option>
                      <option value="V">V</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <p class="text-lg text-[#b9da05] font-semibold mb-2">Demographic Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <label for="birthdate" class="text-white text-sm mb-1 font-semibold">Date of Birth:</label>
                    <input type="date" id="birthdate" />
                  </div>
                  <div>
                    <label for="gender" class="text-white text-sm mb-1 font-semibold">Gender:</label>
                    <select id="gender" class="w-full p-2 mt-1 rounded border border-gray-700 text-white">
                      <option value="">Select Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>
              <div class="md:col-span-2">
                <p class="text-lg text-[#b9da05] font-semibold mb-2">Contact Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <label for="email" class="text-white text-sm mb-1 font-semibold">Email</label>
                    <!-- <input type="email" id="email" name="email" disabled /> -->
                    <p id="email"
                      class="w-full p-2 rounded border border-[#334155] text-gray-400 bg-[#0b1c3a] text-sm mt-1 cursor-not-allowed">
                    </p>
                  </div>
                  <div>
                    <label for="phone" class="text-white text-sm mb-1 font-semibold">Phone</label>
                    <input type="tel" id="phone" name="phone" placeholder="09171234567" />
                  </div>
                  <div class="md:col-span-2">
                    <label for="address" class="text-white text-sm mb-1 font-semibold">Address</label>
                    <input type="text" id="address" placeholder="123 Xof St., Barangay Guinhawa, Malolos City" />
                  </div>
                  <div>
                    <label for="facebook_link" class="text-white text-sm mb-1 font-semibold">Facebook Username</label>
                    <input type="text" id="facebook_link" name="facebook_link" placeholder="xof.delacruz" />
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>
              <div class="md:col-span-2">
                <p class="text-lg text-[#b9da05] font-semibold mb-2">Academic Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <label for="student_college" class="text-white text-sm mb-1 font-semibold">College</label>
                    <select id="student_college" name="student_college"
                      class="w-full p-2 mt-1 rounded border border-gray-700 text-white">
                      <option value="">Select College</option>
                    </select>
                  </div>

                  <div>
                    <label for="student_program" class="text-white text-sm mb-1 font-semibold">Program</label>
                    <select id="student_program" name="student_program"
                      class="w-full p-2 mt-1 rounded border border-gray-700 text-white">
                      <option value="">Select Program</option>
                    </select>
                  </div>

                  <div>
                    <label for="section" class="text-white text-sm mb-1 font-semibold">Section</label>
                    <input type="text" id="section" name="section" placeholder="BSCpE 1A" />
                  </div>
                  <div>
                    <label for="show_student_no" class="text-white text-sm mb-1 font-semibold">Student No.</label>
                    <!-- <input type="text" value=""
                      class="w-full p-2 rounded-md bg-[#27272a] border border-gray-600 text-white placeholder-gray-400 mb-4 cursor-not-allowed"
                      disabled id="student_no" name="student_no" /> -->
                    <p id="show_student_no"
                      class="w-full py-2 px-3 rounded border border-[#334155] text-gray-400 bg-[#0b1c3a] text-sm mt-1 cursor-not-allowed">
                    </p>
                    <input type="hidden" id="student_no_hidden" />
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 border-t border-gray-200 my-1"></div>

              <div class="md:col-span-2">
                <p class="text-lg text-[#b9da05] font-semibold mb-2">Account Information</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                  <div>
                    <label for="username" class="text-white text-sm mb-1 font-semibold">Username</label>
                    <!-- <input type="text" id="username" disabled /> -->
                    <p id="username"
                      class="w-full p-2 rounded border border-[#334155] text-gray-400 bg-[#0b1c3a] text-sm mt-1 cursor-not-allowed">
                    </p>
                  </div>
                  <div>
                    <label for="member_since" class="text-white text-sm mb-1 font-semibold">Member Since:</label>
                    <!-- <p class="font-medium text-white" id="member_since"></p> -->
                    <p id="member_since"
                      class="w-full p-2 rounded border border-[#334155] text-gray-400 bg-[#0b1c3a] text-sm mt-1 cursor-not-allowed">
                    </p>
                  </div>

                  <div class="space-y-2">
                    <label for="profile" class="text-white text-sm font-semibold mb-1 block">
                      Change Profile Picture:
                    </label>
                    <input type="file" id="profile" accept="image/*" />
                    <p class="text-gray-400 text-xs mt-1">Max 5MB. JPG, PNG only.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="badgesContainer" class="w-full h-full mt-4 rounded-lg border border-[#b9da05] flex flex-col">
          <div class="bg-[#011538] h-full pt-4 px-4 sm:px-6 pb-6 rounded-lg flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-base sm:text-lg font-bold text-white">
                Attended Events & Badges
              </h2>
            </div>

            <div class="overflow-y-auto flex-grow">
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4" id="badgeContainer">
              </div>
            </div>
          </div>
        </section>
        <!-- End of Right Secion -->
      </section>

      <!-- Toast Notification: Updated/Failed -->
      <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
        <div id="toast-content"
          class="flex items-center max-w-xs p-4 text-sm text-white bg-green-600 rounded-lg shadow-lg animate-slide-in"
          role="alert">
          <i class="fas fa-check-circle mr-2 text-white"></i>
          <div id="toast-message"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-[#00071c] text-center p-6 border-t border-gray-800">
    <div class="flex justify-center space-x-1 mb-1">
      <a href="https://www.bulsu.edu.ph" target="_blank" rel="noopener noreferrer"><img src="./Logos/BulSU.png"
          alt="Bulacan State University Logo" class="h-10"></a>
      <a href="https://www.facebook.com/osobulsu" target="_blank" rel="noopener noreferrer"><img src="./Logos/OSOA.png"
          alt="Bulacan State University OSOA Logo" class="h-10 w-10"></a>
    </div>
    <p class="text-gray-500 text-sm">&copy; 2025 BulSU Microsoft Student Community. All rights reserved.</p>
    <div class="flex justify-center space-x-4 mt-2">
      <a href="https://www.facebook.com/bulsu.officialmsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-facebook-f"></i></a>
      <a href="https://www.instagram.com/bulsumsc/" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-instagram"></i></a>
      <a href="https://www.threads.com/@bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-threads"></i></a>
      <a href="https://www.tiktok.com/@bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-tiktok"></i></a>
      <a href="https://www.linkedin.com/company/bulsumsc/" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.github.com/bulsumsc" target="_blank"
        class="text-gray-400 hover:text-[#b9da05] transition-colors duration-300"><i class="fab fa-github"></i></a>
    </div>
  </footer>

  <script>
    const API_BASE = "/updated-msc-website/api";

    async function apiCall(endpoint, method = "GET", data = null) {
      try {
        const options = {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_BASE}${endpoint}`, options);
        const result = await response.json();

        return result;
      } catch (error) {
        console.error("API Error:", error);
        return null;
      }
    }

    // Mobile View: Sidebar
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileSidebar = document.getElementById("mobile-sidebar");

    if (menuButton && mobileSidebar) {
      menuButton.addEventListener("click", () => {
        mobileSidebar.classList.toggle("-translate-x-full");
      });

      document.addEventListener("click", function (event) {
        const isClickInsideSidebar = mobileSidebar.contains(event.target);
        const isClickOnMenu = menuButton.contains(event.target);

        if (!isClickInsideSidebar && !isClickOnMenu) {
          mobileSidebar.classList.add("-translate-x-full");
        }
      });
    }

    let originalProfile = {};
    const collegeProgramMap = {
      "College of Architecture and Fine Arts (CAFA)": [
        "BS Architecture",
        "B Landscape Architecture",
        "B Fine Arts Major in Visual Communication",
      ],
      "College of Arts and Letters (CAL)": [
        "BA Broadcasting",
        "BA Journalism",
        "B Performing Arts (Theater Track)",
        "B Sining sa Malikhaing Pagsulat",
      ],
      "College of Business Education and Accountancy (CBEA)": [
        "BS Accountancy",
        "BS Business Administration Major in Business Economics",
        "BS Business Administration Major in Financial Management",
        "BS Business Administration Major in Marketing Management",
        "BS Entrepreneurship",
      ],
      "College of Criminal Justice Education (CCJE)": [
        "BS Criminology",
        "BA Legal Management",
      ],
      "College of Hospitality and Tourism Management (CHTM)": [
        "BS Hospitality Management",
        "BS Tourism Management",
      ],
      "College of Information and Communications Technology (CICT)": [
        "BS Information Technology",
        "BS Information System",
        "B Library and Information Science",
      ],
      "College of Industrial Technology (CIT)": [
        "BIT with specialization in Automotive",
        "BIT with specialization in Computer",
        "BIT with specialization in Drafting",
        "BIT with specialization in Electrical",
        "BIT with specialization in Electronics & Communication Technology",
        "BIT with specialization in Electronics Technology",
        "BIT with specialization in Food Processing Technology",
        "BIT with specialization in Heating, Ventilation, Air Conditioning and Refrigeration Technology (HVACR)",
        "BIT with specialization in Mechanical",
        "BIT with specialization in Mechatronics Technology",
        "BIT with specialization in Welding Technology",
      ],
      "College of Nursing (CON)": ["BS Nursing"],
      "College of Engineering (COE)": [
        "BS Civil Engineering",
        "BS Computer Engineering",
        "BS Electrical Engineering",
        "BS Electronics Engineering",
        "BS Industrial Engineering",
        "BS Manufacturing Engineering",
        "BS Mechanical Engineering",
        "BS Mechatronics Engineering",
      ],
      "College of Education (COED)": [
        "B Early Childhood Education",
        "B Elementary Education",
        "B Physical Education",
        "BSEd Major in English Minor in Mandarin",
        "BSEd in Filipino",
        "BSEd in Mathematics",
        "BSEd in Sciences",
        "BSEd in Social Studies",
        "BSEd in Values Education",
        "BTLEd Major in Home Economics",
        "BTLEd Major in Industrial Arts",
        "BTLEd Major in Information and Communication Technology",
      ],
      "College of Science (CS)": [
        "BS Biology",
        "BS Environmental Science",
        "BS Food Technology",
        "BS Math with Specialization in Applied Statistics",
        "BS Math with Specialization in Business Applications",
        "BS Math with Specialization in Computer Science",
      ],
      "College of Sports, Exercise and Recreation (CSER)": [
        "BS ESS with specialization in Fitness and Sports Coaching",
        "BS ESS with specialization in Fitness and Sports Management",
      ],
      "College of Social Sciences and Philosophy (CSSP)": [
        "B Public Administration",
        "BS Psychology",
        "BS Social Work",
      ]
    };

    const collegeSelect = document.getElementById('student_college');
    const programSelect = document.getElementById('student_program');

    function populateColleges(selectedCollege = "") {
      collegeSelect.innerHTML = '<option value="">Select College</option>';
      Object.keys(collegeProgramMap).forEach(college => {
        const option = document.createElement('option');
        option.value = college;
        option.textContent = college;
        if (college === selectedCollege) option.selected = true;
        collegeSelect.appendChild(option);
      });
    }

    function populatePrograms(selectedCollege, selectedProgram = "") {
      programSelect.innerHTML = '<option value="">Select Program</option>';

      if (selectedCollege && collegeProgramMap[selectedCollege]) {
        collegeProgramMap[selectedCollege].forEach(program => {
          const option = document.createElement('option');
          option.value = program;
          option.textContent = program;
          if (program === selectedProgram) option.selected = true;
          programSelect.appendChild(option);
        });
      }
    }

    collegeSelect.addEventListener('change', (e) => {
      populatePrograms(e.target.value);
    });

    async function fetchProfile() {
      //try {
      const data = await apiCall("/auth/profile");

      if (!data || !data.success) {
        window.location.href = "login.html";
        loadingScreen.classList.add("opacity-0");
        setTimeout(() => window.location.href = "login.html", 800);
        return;
      }

      const user = data.data;
      originalProfile = { ...user };

      fetchAndDisplayEventBadges(user.id);

      // Text fields
      document.getElementById("msc_id").textContent = user.msc_id;
      generateQRCode(user.msc_id || user.student_no);
      document.getElementById("fullName").textContent = `${user.first_name} ${user.last_name}`;
      document.getElementById("studentID").textContent = user.student_no;
      document.getElementById("program").textContent = user.program;
      document.getElementById("college").textContent = user.college;
      document.getElementById("year_level").textContent = user.year_level;
      document.getElementById("role").textContent = user.role;

      document.getElementById("firstName").value = user.first_name || "";
      document.getElementById("middleName").value = user.middle_name || "";
      document.getElementById("lastName").value = user.last_name || "";
      document.getElementById("name_suffix").value = user.name_suffix || "";
      document.getElementById("birthdate").value = user.birthdate || "";
      document.getElementById("gender").value = user.gender || "";
      document.getElementById("student_no_hidden").value = user.student_no || "";
      document.getElementById("show_student_no").textContent = user.student_no;

      document.getElementById("student_college").value = user.college || "";
      document.getElementById("student_program").value = user.program || "";
      document.getElementById("section").value = user.section || "";
      document.getElementById("address").value = user.address || "";
      document.getElementById("phone").value = user.phone || "";
      document.getElementById("facebook_link").value = user.facebook_link || "";
      //document.getElementById("username").value = user.username || "";
      document.getElementById("username").textContent = user.username || "";
      document.getElementById("email").textContent = user.email || "";

      // Populate and pre-select college + program
      populateColleges(user.college || "");
      populatePrograms(user.college || "", user.program || "");

      // Member since
      const createdDate = new Date(user.created_at);
      document.getElementById("member_since").textContent = createdDate.toLocaleDateString("en-US", {
        year: "numeric", month: "long", day: "numeric"
      });
      //document.getElementById("member_since2").textContent = createdDate.toLocaleDateString("en-US");

      // Profile picture initials
      const initials = `${user.first_name?.charAt(0) || ""}${user.last_name?.charAt(0) || ""}`.toUpperCase();
      renderProfilePicture(user.profile_image_path, initials);

      attachChangeListeners();
      document.documentElement.classList.remove("loading");
      // } catch (err) {
      //   console.error("Failed to fetch user profile:", err);
      // }
    }

    function formatDateInput(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toISOString().split("T")[0];
    }

    function hasProfileChanged() {
      const imageChanged = document.getElementById("profile")?.files.length > 0;

      const fieldChanged = [
        ["firstName", "first_name"],
        ["middleName", "middle_name"],
        ["lastName", "last_name"],
        ["name_suffix", "name_suffix"],
        ["birthdate", "birthdate"],
        ["gender", "gender"],
        ["student_no", "student_no"],
        ["student_college", "college"],
        ["student_program", "program"],
        ["section", "section"],
        ["address", "address"],
        ["phone", "phone"],
        ["facebook_link", "facebook_link"]
      ].some(([id, field]) => {
        const element = document.getElementById(id);
        const currentValue = (element?.value || "").trim();
        const originalValue = (originalProfile[field] || "").trim();
        return currentValue !== originalValue;
      });

      return fieldChanged || imageChanged;
    }

    function attachChangeListeners() {
      const fields = document.querySelectorAll("input, select");
      const saveBtn = document.getElementById("saveBtn");

      fields.forEach(input => {
        input.addEventListener("input", () => {
          if (hasProfileChanged()) {
            saveBtn.classList.remove("pointer-events-none", "opacity-50");
          } else {
            saveBtn.classList.add("pointer-events-none", "opacity-50");
          }
        });
      });

      const fileInput = document.getElementById("profile");
      if (fileInput) {
        fileInput.addEventListener("change", () => {
          if (hasProfileChanged()) {
            saveBtn.classList.remove("pointer-events-none", "opacity-50");
          } else {
            saveBtn.classList.add("pointer-events-none", "opacity-50");
          }

          const file = fileInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const container = document.getElementById("profile-picture-container");
              container.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" />`;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    async function updateProfile() {
      const saveBtn = document.getElementById("saveBtn");

      if (!hasProfileChanged()) {
        showToast("No changes made to profile.", "error");
        return;
      }

      try {
        const profileData = await apiCall("/auth/profile");
        if (!profileData || !profileData.success) {
          alert("Session expired. Please login again.");
          window.location.href = "login.html";
          return;
        }

        const user = profileData.data;
        const studentId = user.id;

        // Upload profile picture separately (if changed)
        const fileInput = document.getElementById("profile");
        let uploadedImagePath = user.profile_image_path;

        if (fileInput && fileInput.files.length > 0) {
          uploadedImagePath = await uploadProfilePicture(studentId);
          if (!uploadedImagePath) {
            showToast("Failed to upload image", "error");
            return;
          }
        }

        /*
        const payload = {
          first_name: document.getElementById("firstName").value.trim(),
          middle_name: document.getElementById("middleName").value.trim(),
          last_name: document.getElementById("lastName").value.trim(),
          name_suffix: document.getElementById("name_suffix").value.trim(),
          birthdate: document.getElementById("birthdate").value,
          gender: document.getElementById("gender").value,
          //student_no: document.getElementById("student_no").value.trim(),
          student_no: document.getElementById("student_no_hidden").value || user.student_no,
          year_level: user.year_level,
          college: document.getElementById("student_college").value.trim(),
          program: document.getElementById("student_program").value.trim(),
          section: document.getElementById("section").value.trim(),
          address: document.getElementById("address").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          facebook_link: document.getElementById("facebook_link").value.trim(),
          profile_image_path: uploadedImagePath || null
        };
        */
       
        const payload = {
          first_name: document.getElementById("firstName").value.trim() || null,
          middle_name: document.getElementById("middleName").value.trim() || null,
          last_name: document.getElementById("lastName").value.trim() || null,
          name_suffix: document.getElementById("name_suffix").value.trim() || null,
          birthdate: document.getElementById("birthdate").value || null,
          gender: document.getElementById("gender").value || null,
          student_no: document.getElementById("student_no_hidden").value || user.student_no,
          year_level: user.year_level,
          college: document.getElementById("student_college").value.trim() || null,
          program: document.getElementById("student_program").value.trim() || null,
          section: document.getElementById("section").value.trim() || null,
          address: document.getElementById("address").value.trim() || null,
          phone: document.getElementById("phone").value.trim() || null,
          facebook_link: document.getElementById("facebook_link").value.trim() || null,
          profile_image_path: uploadedImagePath || null
        };

        console.log("Payload being sent:", payload);

        const updateResult = await apiCall(`/students/profile/${studentId}`, "PUT", payload);

        if (updateResult && updateResult.success) {
          showToast("Profile updated successfully!", "success");

          originalProfile = { ...originalProfile, ...payload };
          saveBtn.classList.add("pointer-events-none", "opacity-50");
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          console.error(updateResult?.message);
          showToast("Failed to update profile.", "error");
        }

      } catch (err) {
        console.error("Error updating profile:", err);
        showToast("An error occurred while updating profile.", "error");
      }
    }

    //Profile Pic Generator
    function renderProfilePicture(profilePictureUrl, initials) {
      const container = document.getElementById("profile-picture-container");
      if (!container) return;

      container.innerHTML = "";

      if (profilePictureUrl) {
        const img = document.createElement("img");

        let fullUrl = profilePictureUrl;
        if (profilePictureUrl.startsWith("/uploads")) {
          fullUrl = `${API_BASE.replace("/api", "")}${profilePictureUrl}`;
        }

        img.src = fullUrl;
        img.alt = "Profile Picture";
        img.className = "w-full h-full object-cover";
        container.appendChild(img);
      } else {
        const div = document.createElement("div");
        div.className =
          "w-full h-full rounded-full bg-[#03378f] text-white flex items-center justify-center text-4xl font-bold";
        div.textContent = initials;
        container.appendChild(div);
      }
    }

    function generateQRCode(data) {
      const qrContainer = document.getElementById("qr-code");
      qrContainer.innerHTML = ""; // Clear previous QR

      new QRCode(qrContainer, {
        text: data,
        width: 120,
        height: 120,
        colorDark: "#06047b",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H,
      });
    }

    document.addEventListener("DOMContentLoaded", fetchProfile);

    async function fetchAndDisplayEventBadges(studentId) {
      try {
        const data = await apiCall(`/events/attended/${studentId}`);

        if (data && data.success && Array.isArray(data.data)) {
          const events = data.data;
          const badgeContainer = document.getElementById("badgeContainer");
          badgeContainer.innerHTML = "";
          const attendedEvents = events.filter(ev => ev.attendance_status === "attended");

          if (attendedEvents.length === 0) {
            badgeContainer.className = "flex justify-center items-center h-full col-span-full p-4";
            badgeContainer.innerHTML = `
                    <div class="text-center text-white/50">
                        <i class="fas fa-certificate text-4xl mb-4"></i>
                        <p class="text-lg">No badges available.</p>
                    </div>
                `;
          } else {
            badgeContainer.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4"; // 'p-4' added here

            attendedEvents.forEach(ev => {
              console.log(ev.event_batch_image);
              const card = document.createElement("div");
              card.className = "group relative flex flex-col items-center p-6 bg-[#011538] border border-white/20 rounded-2xl shadow-xl hover:border-[#b9da05] transition-all duration-300 cursor-pointer overflow-hidden";

              card.innerHTML = `
                        <div class="absolute inset-0 bg-gradient-to-br from-[#011538] to-[#1a2f57] opacity-80 rounded-2xl transition-opacity duration-300 group-hover:opacity-90"></div>
                        <div class="relative z-10 w-20 h-20 mb-4 flex items-center justify-center rounded-full bg-white/10 p-2 border-2 border-white/30 transition-all duration-300 group-hover:bg-[#b9da05]/20 group-hover:border-[#b9da05]">
                            ${ev.event_batch_image
                  ? `<img src="${ev.event_batch_image}" alt="Event Badge" class="rounded-full object-cover w-full h-full transform transition-transform duration-300 group-hover:scale-110" />`
                  : `<i class="bi bi-calendar-event text-blue-500 text-3xl"></i>`}
                        </div>
                        <h3 class="relative z-10 text-lg font-semibold text-white text-center truncate w-full px-2 transition-colors duration-300 group-hover:text-[#b9da05]">${ev.event_name}</h3>
                        <p class="relative z-10 text-sm text-white/70 mt-1 transition-colors duration-300 group-hover:text-white">${formatDate(ev.event_date)}</p>
                    `;
              badgeContainer.appendChild(card);
            });
          }
        }
      } catch (err) {
        console.error("Error loading event badges:", err);
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric"
      });
    }

    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");
      const toastContent = document.getElementById("toast-content");

      toastMessage.textContent = message;

      if (type === "success") {
        toastContent.className = "flex items-center max-w-xs p-4 text-sm text-white bg-green-600 rounded-lg shadow-lg animate-slide-in";
        toastContent.querySelector("i").className = "fas fa-check-circle mr-2 text-white";
      } else if (type === "error") {
        toastContent.className = "flex items-center max-w-xs p-4 text-sm text-white bg-red-600 rounded-lg shadow-lg animate-slide-in";
        toastContent.querySelector("i").className = "fas fa-times-circle mr-2 text-white";
      }

      toast.classList.remove("hidden");
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 5000);
    }

    async function uploadProfilePicture(studentId) {
      const fileInput = document.getElementById("profile");
      const file = fileInput?.files?.[0];
      if (!file) return null;

      const allowedTypes = ["image/jpeg", "image/png"];
      const maxSize = 5 * 1024 * 1024; // 5MB

      if (!allowedTypes.includes(file.type)) {
        showToast("Invalid file format. Please upload a JPG or PNG image.", "error");
        return null;
      }

      if (file.size > maxSize) {
        showToast("File is too large. The maximum allowed size is 5MB.", "error");
        return null;
      }

      const formData = new FormData();
      formData.append("profile", file);

      try {
        const res = await fetch(`${API_BASE}/students/upload-profile/${studentId}`, {
          method: "POST",
          credentials: "include",
          body: formData
        });

        const result = await res.json();

        if (res.ok && result.success) {
          return result.data.path;
        } else {
          showToast(result.message || "Profile image upload failed.", "error");
          return null;
        }
      } catch (error) {
        console.error("Error uploading profile picture:", error);
        showToast("Error uploading profile picture.", "error");
        return null;
      }
    }
  </script>

</body>

</html>