<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Committees | BulSU MSC</title>
  <link href="./Logos/Bulsu MSC Logo-02.png" rel="icon" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #080c24;
      color: #ffffff;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background-color: #00071c;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }

    .logo-section {
      text-align: center;
      padding: 0 20px 30px;
      border-bottom: 1px solid #1a1f3a;
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .logo-section img {
      width: 60px;
      height: 60px;
      margin-bottom: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    .logo-section h2 {
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      font-weight: 700;
      color: #b9da05;
      margin-bottom: 5px;
    }

    .logo-section p {
      font-size: 12px;
      color: #8892b0;
    }

    .nav-menu {
      list-style: none;
      padding: 0 15px;
    }

    .nav-menu li {
      margin-bottom: 8px;
    }

    .nav-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #8892b0;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-menu a:hover,
    .nav-menu a.active {
      background-color: #011538;
      color: #b9da05;
      transform: translateX(5px);
    }

    .nav-menu a i {
      margin-right: 12px;
      font-size: 16px;
      width: 20px;
    }

    .footer-section {
      margin-top: auto;
      padding: 20px;
      text-align: center;
      border-top: 1px solid #1a1f3a;
    }

    .footer-section p {
      font-size: 10px;
      color: #64748b;
      line-height: 1.4;
    }

    .main-content {
      margin-left: 280px;
      flex: 1;
      padding: 30px;
      background-color: #080c24;
    }

    .header {
      margin-bottom: 30px;
    }

    .header h1 {
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 700;
      color: #b9da05;
      margin-bottom: 5px;
    }

    .header p {
      color: #8892b0;
      font-size: 14px;
    }

    .card {
      background-color: #011538;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid #1a1f3a;
    }

    .card h3 {
      font-family: 'Segoe UI', sans-serif;
      font-size: 20px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 20px;
    }

    .committee-card {
      background-color: #011538;
      border: 1px solid #1a1f3a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    
    .committee-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(185, 218, 5, 0.15);
      border-color: #b9da05;
    }
    
    .committee-title {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .committee-description {
      color: #8892b0;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .committee-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 2px solid #1a1f3a;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 15px 25px;
      color: #8892b0;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
    }

    .tab-button:hover {
      color: #b9da05;
    }

    .tab-button.active {
      color: #b9da05;
      border-bottom-color: #b9da05;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: #b9da05;
      color: #000000;
    }

    .btn-primary:hover {
      background-color: #a8c905;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background-color: #7fba00;
      color: #ffffff;
    }

    .btn-secondary:hover {
      background-color: #6c9d01;
    }

    .btn-danger {
      background-color: #ef4444;
      color: #ffffff;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }

    .btn-info {
      background-color: #06b6d4;
      color: #ffffff;
    }

    .btn-info:hover {
      background-color: #0891b2;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #ffffff;
      font-weight: 500;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      background-color: #1a1f3a;
      border: 1px solid #374151;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #b9da05;
    }

    .form-control::placeholder {
      color: #64748b;
    }

    textarea.form-control {
      min-height: 120px;
      resize: vertical;
    }

    #viewCommitteeModal > div,
    #editCommitteeModal > div {
      border: 2px solid #b9da05;
      box-shadow: 0 8px 25px rgba(185, 218, 5, 0.15);
    }
    
      #toast.show {
        display: block;
        background: #b9da05;
        animation: fadeInUp 0.5s, fadeOutDown 0.5s 2.5s forwards;
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOutDown {
        from { opacity: 1; transform: translateY(0); }
        to   { opacity: 0; transform: translateY(20px); }
      }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="logo-section">
        <img src="./Logos/Bulsu MSC Logo-02.png" alt="BulSU MSC Logo" onerror="this.style.display='none'">
        <h2>BulSU MSC</h2>
        <p>ADMINISTRATOR</p>
      </div>
      <ul class="nav-menu">
        <li><a href="admin_dashboard.html"><i class="bi bi-speedometer2"></i>Dashboard</a></li>
        <li><a href="admin_manage_members.html"><i class="bi bi-people"></i>Members</a></li>
        <li><a href="admin_manage_committees.html" class="active"><i class="bi bi-diagram-3"></i>Committees</a></li>
        <li><a href="admin_manage_announcements.html"><i class="bi bi-megaphone"></i>Announcements</a></li>
        <li><a href="admin_manage_events.html"><i class="bi bi-calendar-event"></i>Events</a></li>
        <li><a href="verify_attendance.html"><i class="bi bi-check2-square"></i>Attendance Verifier</a></li>
        <li><a href="admin_calendar.html"><i class="bi bi-calendar3"></i>Calendar</a></li>
      </ul>
      <div class="footer-section">
        <p>&copy; 2024 Bulacan State University<br>Microsoft Student Community<br>All Rights Reserved.</p>
      </div>
    </nav>

    <button id="sidebarToggle" class="lg:hidden fixed top-4 right-4 z-50 bg-[#b9da05] text-[#011538] p-2 rounded-md">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Main content -->
    <main class="main-content">
      <div class="header">
        <h1>Manage Committees</h1>
        <p>Create and manage committees for the BulSU MSC community</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-button active" data-tab="committee-list">Committee List</button>
        <button class="tab-button" data-tab="add-committee">Add New Committee</button>
      </div>

      <!-- Committee list -->
      <div id="committee-list" class="tab-content active"></div>

      <!-- Add new committee -->
      <div id="add-committee" class="tab-content">
        <div class="card">
          <h3>Create New Committee</h3>
          <form id="addCommitteeForm">
            <div class="form-group">
              <label for="committeeName">Committee Name:</label>
              <input type="text" id="committeeName" name="name" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="committeeDescription">Description:</label>
              <textarea id="committeeDescription" name="description" class="form-control" required placeholder="Describe the committee's purpose and responsibilities..."></textarea>
            </div>
            <div class="form-group">
              <label for="committeeHead">Committee Head:</label>
              <select id="officerOptions" name="committeeHead" class="form-control" required>
                <option value="">Select Committee Head</option>
              </select>
            </div>
            <div class="form-group">
              <label>Committee Associates:</label>
              <div id="membersContainer"></div>
              <button type="button" id="addMemberBtn" class="btn btn-secondary mt-2">+ Add Officer</button>
            </div>
            <button type="submit" class="btn btn-primary">Create Committee</button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- View Committee Modal -->
  <div id="viewCommitteeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-[#011538] p-6 rounded-lg w-96">
      <h3 class="text-white text-lg font-semibold mb-4" id="viewCommitteeName"></h3>
      <p class="text-gray-300 mb-2" id="viewCommitteeDescription"></p>
      <p class="text-gray-300"><strong>Head:</strong> <span id="viewCommitteeHead"></span></p>
      <p class="text-gray-300"><strong>Associates:</strong></p>
      <ul id="viewCommitteeMembers" class="list-disc list-inside text-gray-400"></ul>
      <div class="flex justify-end mt-4">
        <button id="closeViewModal" class="btn btn-danger">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Committee Modal -->
  <div id="editCommitteeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-[#011538] p-6 rounded-lg w-96">
      <h3 class="text-white text-lg font-semibold mb-4">Edit Committee</h3>
      <form id="editCommitteeForm">
        <input type="hidden" id="editCommitteeId">
        <div class="form-group">
          <label>Name:</label>
          <input type="text" id="editCommitteeName" class="form-control">
        </div>
        <div class="form-group">
          <label>Description:</label>
          <textarea id="editCommitteeDescription" class="form-control"></textarea>
        </div>
        <div class="form-group">
          <label>Head:</label>
          <select id="editOfficerOptions" class="form-control"></select>
        </div>
        <div class="form-group">
          <label>Associates:</label>
          <div id="editMembersContainer"></div>
          <button type="button" id="addEditMemberBtn" class="btn btn-secondary mt-2">+ Add Officer</button>
        </div>
        <div class="flex justify-end gap-2">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" id="closeEditModal" class="btn btn-danger">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 hidden px-4 py-3 rounded-lg shadow-lg text-[#011538] font-semibold z-[9999]"></div>

    <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-[#011538] border-2 border-[#b9da05] shadow-lg shadow-[#b9da05]/20 p-6 rounded-lg w-96">
      <h3 class="text-white text-lg font-semibold mb-4">Confirm Delete</h3>
      <p class="text-gray-300 mb-6">Are you sure you want to delete this committee?</p>
      <div class="flex justify-end gap-2">
        <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const API_BASE = "/updated-msc-website/api"; // <--- Added API base

      // Sidebar toggle
      const sidebarToggle = document.getElementById('sidebarToggle');
      sidebarToggle?.addEventListener('click', () => 
        document.querySelector('.sidebar').classList.toggle('open')
      );

      // Tabs
      document.querySelectorAll('.tab-button').forEach(tab => {
        tab.addEventListener('click', function() {
          const targetTab = this.dataset.tab;
          document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          document.getElementById(targetTab)?.classList.add('active');
        });
      });

      // Generic API call
      async function apicall(url, method = "GET", data = null, isFormData = false) {
        const options = { method, headers: {} };
        if (isFormData) {
          options.body = data;
          if (method === "PUT" || method === "PATCH") {
            url += (url.includes("?") ? "&" : "?") + `_method=${method}`;
            options.method = "POST";
          }
        } else if (data) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(data);
        }
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            const text = await res.text();
            console.error(`API error (${res.status}):`, text);
            return null;
          }
          return await res.json();
        } catch (err) {
          console.error("API call error:", err);
          return null;
        }
      }

    // Map of all students for easy lookup
    let studentsMap = {};

    async function loadStudentsMap() {
      const res = await apicall(`${API_BASE}/students`, "GET"); // Get all students
      const students = res?.data?.students || [];
      students.forEach(s => {
        studentsMap[s.id] = `${s.first_name} ${s.last_name}`;
      });
    }

    let deleteCommitteeId = null;

    function openDeleteModal(id, name) {
      deleteCommitteeId = id;
      document.getElementById("deleteConfirmModal").classList.remove("hidden");
    }

    function closeDeleteModal() {
      deleteCommitteeId = null;
      document.getElementById("deleteConfirmModal").classList.add("hidden");
    }

    document.getElementById("cancelDeleteBtn")?.addEventListener("click", closeDeleteModal);

    document.getElementById("confirmDeleteBtn")?.addEventListener("click", async () => {
      if (deleteCommitteeId) {
        const res = await apicall(`${API_BASE}/committees/${deleteCommitteeId}`, "DELETE");
        if (res?.success) {
          showToast("Committee deleted!");
          loadCommittees();
        } else {
          showToast("Failed to delete committee.");
        }
        closeDeleteModal();
      }
    });


    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.remove("hidden");
      toast.classList.add("show");

      setTimeout(() => {
        toast.classList.remove("show");
        toast.classList.add("hidden");
      }, 3000); // auto-hide after 3s
    }


      // Load officers into select dropdown
      async function loadOfficers() {
        const officerSelect = document.getElementById("officerOptions");
        if (!officerSelect) return;
        officerSelect.innerHTML = '<option value="">Select Committee Officer</option>';

        const result = await apicall(`${API_BASE}/students?role=officer`, "GET");
        const officers = result?.data?.students || [];
        if (officers.length > 0) {
          officers.forEach(officer => {
            const option = document.createElement("option");
            option.value = officer.id;
            option.textContent = `${officer.first_name} ${officer.last_name}`;
            officerSelect.appendChild(option);
          });
        } else {
          officerSelect.innerHTML += '<option value="">No officers found</option>';
        }
      }

      // Load committees

    async function loadCommittees() {
      const container = document.getElementById("committee-list");
      container.innerHTML = "";
      const result = await apicall(`${API_BASE}/committees`, "GET");
      const committees = result?.data || [];
      if (!committees.length) {
        container.innerHTML = "<p class='text-gray-400'>No committees found.</p>";
        return;
      }

      committees.forEach(c => {
        const card = document.createElement("div");
        card.classList.add("committee-card");
        card.innerHTML = `
          <h3 class="committee-title">${c.name}</h3>
          <p class="committee-description">${c.description || ""}</p>
          <p class="committee-head">Head: ${c.head?.full_name || 'N/A'}</p>
          <div class="committee-actions">
            <button class="btn btn-info view-btn">View</button>
            <button class="btn btn-secondary edit-btn">Edit</button>
            <button class="btn btn-danger delete-btn">Delete</button>
          </div>
        `;
        container.appendChild(card);

      // Create a map of officers for easy lookup
      const officersMap = {};
      document.querySelectorAll('#officerOptions option').forEach(opt => {
        if (opt.value) officersMap[opt.value] = opt.textContent;
      });

      // VIEW
      card.querySelector('.view-btn')?.addEventListener('click', async () => {
        const res = await apicall(`${API_BASE}/committees/${c.committee_id}`, "GET");
        if (!res) return;
        const committee = res.data;

        document.getElementById('viewCommitteeName').textContent = committee.name;
        document.getElementById('viewCommitteeDescription').textContent = committee.description || '';

        document.getElementById('viewCommitteeHead').textContent =
            officersMap[committee.head_id] || 'N/A';

        // ✅ FIX: re-add this line
        const membersList = document.getElementById('viewCommitteeMembers');
        membersList.innerHTML = '';

        (committee.members || []).forEach(m => {
          const li = document.createElement('li');
          const name = studentsMap[m.student_id] || `ID ${m.student_id}`;
          li.textContent = m.position 
            ? `${name} – ${m.position}`
            : name;
          membersList.appendChild(li);
        });

        document.getElementById('viewCommitteeModal').classList.remove('hidden');
      });


        // EDIT
        card.querySelector('.edit-btn')?.addEventListener('click', async () => {
          const res = await apicall(`${API_BASE}/committees/${c.committee_id}`, "GET");
          if (!res) return;
          const committee = res.data;

          document.getElementById('editCommitteeId').value = committee.committee_id;
          document.getElementById('editCommitteeName').value = committee.name;
          document.getElementById('editCommitteeDescription').value = committee.description || '';

          const editHeadSelect = document.getElementById('editOfficerOptions');
          editHeadSelect.innerHTML = document.getElementById('officerOptions').innerHTML;
          editHeadSelect.value = committee.head_id || '';

          const membersContainer = document.getElementById('editMembersContainer');
          membersContainer.innerHTML = '';
          (committee.members || []).forEach(m => {
            const wrapper = document.createElement('div');
            wrapper.classList.add('member-item', 'flex', 'gap-2', 'mb-2');

            const select = document.createElement('select');
            select.classList.add('form-control');
            select.innerHTML = document.getElementById('officerOptions').innerHTML;
            select.value = m.student_id || '';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Position Name';
            input.classList.add('form-control');
            input.value = m.position || '';

            wrapper.appendChild(select);
            wrapper.appendChild(input);
            membersContainer.appendChild(wrapper);
          });

          document.getElementById('editCommitteeModal').classList.remove('hidden');
        });

        // DELETE
        card.querySelector('.delete-btn')?.addEventListener('click', async () => {
          openDeleteModal(c.committee_id, c.name);
        });
      });
    }

    // Close modals
    document.getElementById('closeViewModal')?.addEventListener('click', () => {
      document.getElementById('viewCommitteeModal').classList.add('hidden');
    });
    document.getElementById('closeEditModal')?.addEventListener('click', () => {
      document.getElementById('editCommitteeModal').classList.add('hidden');
    });

    // Add/Edit Member buttons (outside loop)
    document.getElementById('addEditMemberBtn')?.addEventListener('click', () => {
      const wrapper = document.createElement('div');
      wrapper.classList.add('member-item', 'flex', 'gap-2', 'mb-2');

      const select = document.createElement('select');
      select.classList.add('form-control');
      select.innerHTML = document.getElementById('officerOptions').innerHTML;

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Position Name';
      input.classList.add('form-control');

      wrapper.appendChild(select);
      wrapper.appendChild(input);
      document.getElementById('editMembersContainer').appendChild(wrapper);
    });

    document.getElementById('addMemberBtn')?.addEventListener('click', () => {
      const wrapper = document.createElement('div');
      wrapper.classList.add('member-item', 'flex', 'gap-2', 'mb-2');

      const select = document.createElement('select');
      select.classList.add('form-control');
      select.innerHTML = document.getElementById('officerOptions').innerHTML;

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Position Name';
      input.classList.add('form-control');

      wrapper.appendChild(select);
      wrapper.appendChild(input);
      document.getElementById('membersContainer').appendChild(wrapper);
    });

    // Edit form submit
    document.getElementById('editCommitteeForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('editCommitteeId').value;
      const name = document.getElementById('editCommitteeName').value.trim();
      const description = document.getElementById('editCommitteeDescription').value.trim();
      const head_id = document.getElementById('editOfficerOptions').value;

      const members = Array.from(document.querySelectorAll('#editMembersContainer .member-item'))
        .map(wrapper => ({
          student_id: wrapper.querySelector('select').value,
          position: wrapper.querySelector('input').value || null
        }))
        .filter(m => m.student_id);

      const payload = { name, description, head_id, members };
      const res = await apicall(`${API_BASE}/committees/${id}`, "PUT", payload);
      if (res?.success) {
        showToast("Committee updated!");
        document.getElementById('editCommitteeModal').classList.add('hidden');
        loadCommittees();
      } else {
        showToast("Failed to update: " + (res?.message || "Unknown error"));
      }
    });


      // Add Committee Form
      const addForm = document.getElementById('addCommitteeForm');
      addForm?.addEventListener('submit', async e => {
        e.preventDefault();

        const committeeName = document.getElementById("committeeName").value.trim();
        const committeeDescription = document.getElementById("committeeDescription").value.trim();
        const headId = document.getElementById("officerOptions")?.value;

        if (!committeeName) {
          alert("Committee name is required!");
          return;
        }

        // Collect members from the membersContainer
        const memberItems = document.querySelectorAll('#membersContainer .member-item');
        const members = Array.from(memberItems)
          .map(wrapper => ({
            student_id: wrapper.querySelector('select').value,
            position: wrapper.querySelector('input').value || null
          }))
          .filter(m => m.student_id);

        const newCommittee = {
          name: committeeName,
          description: committeeDescription,
          head_id: headId || null,
          members: members
        };

        console.log("Payload to backend:", newCommittee);

        const res = await apicall(`${API_BASE}/committees`, "POST", newCommittee);

        if (res?.success) {
          showToast("Committee created!");
          addForm.reset();
          document.getElementById('membersContainer').innerHTML = '';
          document.querySelector('[data-tab="committee-list"]').click();
          loadCommittees();
        } else {
          showToast("Failed: " + (res?.message || "Unknown error"));
        }
      });

      // Initial load
      await loadStudentsMap(); // Load all students first
      await loadCommittees();   // Then load committees
      await loadOfficers();     // Finally load officers for dropdowns
    });
  </script>
</body>
</html>
